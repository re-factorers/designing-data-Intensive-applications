# TCP Flow Control

- `TCP` 는 신뢰할 수 없는 네트워크 상에서 신뢰할 수 있는 통신을 보장하는 프로토콜이다. 한 노드로 데이터를 보낼 때 패킷은 손실될 수 있으며, 순서가 어긋나게 도착할 수 도 있다. 네트워크는 혼잡해지거나 수신 노드 측에서는 과도하게 수신되어질 수 도 있다. 그럼에도 어플리케이션을 구현할 때 이러한 복잡성을 고려할 필요 없다. 그저 소켓에 데이터를 쓰고 TCP에 맡기면 수신 노드로 정확하게 전달해주기 때문이다.

## Flow Control ?

- Flow control은 `TCP` 가 수신자가 처리할 수 있는 속도보다 더 빠르게 발신자 측에서 패킷을 보내지 않도록 보장한다. 분산 시스템의 _Back Pressure_ 와 유사하다. 아이디어의 핵심은 데이터를 수신하는 노드가 데이터를 보내는 노드로 피드백을 주어 자신의 상태를 알게하는데에 있다.
- `Congestion Control` 과는 다르다는 점이 중요하다. `Congestion Control` 은 두 노드 사이의 링크와 같은 네트워크가 혼잡되는 것을 방지하는 것 이고, `Flow Control`은 end-node의 혼잡을 방지한다.

## 동작 방식

- 송신하는 어플리케이션은 소켓에 데이터를 쓰고, transport 레이어는 이 데이터를 세그먼트에 감싸서 network 레이어(e.g. IP)로 전달한다.
- 이 통신의 반대편에서는, network 레이어는 이 데이터의 조각을 TCP로 전달하여 수신하는 어플리케이션이 전송된 데이터의 정확한 사본을 갖도록 한다.

좀 더 자세히 살펴보자면,

- TCP는 데이터를 저장하고, _send buffer_ 로 보낸다. 그리고 _receive buffer_ 에서는 데이터를 받았다가 수신받는 어플리케이션이 준비되었을 때 이 버퍼로부터 데이터를 읽는다.
- Flow Control 이 결국하는 것은 receive buffer가 가득찼을 때는 더 이상 패킷을 보내지 않는다는 것 이다.
- TCP가 전송할 수 있는 데이터의 양을 제어하기 위해서는 수신자가 자신의 _Receive Window(rwnd)_ 를 알려야 한다. _Receive Window_ 란, TCP Receive buffer 에서 현재 여유있는 공간을 의미한다.
- TCP가 패킷을 받을 때 마다, `ack` 메세지를 송신자에게 전달하여 패킷을 정상적으로 수신했다고 확인시켜야한다. 그리고 `ack` 메세지는 현재의 receive window 값을 전달하여 송신자가 데이터 전송을 계속해도 되는지를 알 수 있게해야한다.

## The sliding window

- TCP는 슬라이딩 윈도우 프로토콜을 사용하여 전송할 수 있는 바이트 수를 제어한다.
- A 노드에서 B 노드로 150000 바이트의 파일을 보낸다고 해보자. TCP는 이 파일을 100개의 패킷으로 쪼갠다. A와 B가 연결되었을 때, 노드 B는 receive window가 45000 바이트라고 알린다. 그러면 TCP는 ack 메세지를 받기전에 처음에 30 패킷 (1500\*30 = 45000)을 보낼 수 있음을 알게된다.
- 만약 첫 10개 패킷에 대한 ack 메시지를 받고, 이 ack 메시지내에서 receive window가 여전히 45000 이라고 알린다면 TCP는 다음 10개의 패킷을 보낼 수 있게되는 것 이고, 전송중에 있는 패킷의 개수는 30개로 유지되는 것이다. 이 30개라는 것은 receive window에 의해 정의된 상한선이고, 어느 시점에서나 아직 ack가 되지 않은 30개의 패킷이 전송중임을 의미한다.
